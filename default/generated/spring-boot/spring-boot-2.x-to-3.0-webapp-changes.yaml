- ruleID: spring-boot-2.x-to-3.0-webapp-changes-00000
  category: optional
  effort: 1
  labels:
    - konveyor.io/source=spring-boot2
    - konveyor.io/target=spring-boot3+
  when:
    builtin.filecontent:
      filePattern: .*\.properties
      pattern: server\.max-http-header-size
  description: 'server.max-http-header-size has been deprecated'
  message: |
    Previously, the `server.max-http-header-size` was treated inconsistently across the four supported embedded web
    servers. When using Jetty, Netty, or Undertow it would configure the max HTTP request header size.
    When using Tomcat it would configure the max HTTP request and response header sizes.

    To address this inconsistency, `server.max-http-header-size` has been deprecated and a replacement,
    `server.max-http-request-header-size`, has been introduced. Both properties now only apply to the request header
    size, irrespective of the underlying web server.

    To limit the max header size of an HTTP response on Tomcat or Jetty (the only two servers that support such
    a setting), use a `WebServerFactoryCustomizer`.

  links:
    - title: 'Spring Boot 3.0 Migration Guide - Web application changes'
      url: https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#servermax-http-header-size


- ruleID: spring-boot-2.x-to-3.0-webapp-changes-00010
  category: potential
  effort: 3
  labels:
    - konveyor.io/source=spring-boot2
    - konveyor.io/target=spring-boot3+
  when:
    java.referenced:
      pattern: org.springframework.context.SmartLifecycle
      location: IMPLEMENTS_TYPE
  description: "Updated Phases for Graceful Shutdown"
  message: |
    The phases used by the `SmartLifecycle` implementations for graceful shutdown have been updated. Graceful shutdown
    now begins in phase `SmartLifecycle.DEFAULT_PHASE` - 2048 and the web server is stopped in phase
    `SmartLifecycle.DEFAULT_PHASE` - 1024. Any `SmartLifecycle` implementations that were participating
    in graceful shutdown should be updated accordingly.

  links:
    - title: 'Spring Boot 3.0 Migration Guide - Web application changes'
      url: https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#updated-phases-for-graceful-shutdown

- ruleID: spring-boot-2.x-to-3.0-webapp-changes-00020
  category: mandatory
  effort: 3
  labels:
    - konveyor.io/source=spring-boot2
    - konveyor.io/target=spring-boot3+
  when:
    or:
    - java.dependency:
        name: org.eclipse.jetty.jetty-server
        upperbound: 10.99.99
    - java.dependency:
        name: org.eclipse.jetty.jetty-webapp
        upperbound: 10.99.99
  description: Jetty must be upgraded to version 11+ for Spring Boot 3.0
  message: |
    Spring Boot 3.0 requires Jetty 11 or later. Jetty 11 is the first version to support
    Jakarta EE 9 (Servlet 5.0 API with `jakarta.servlet` namespace).

    **Migration Steps:**

    1. **Update Jetty dependencies:**
    ```xml
    <!-- Maven - Spring Boot will manage the version -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-jetty</artifactId>
    </dependency>
    ```

    2. **If using explicit Jetty version:**
    ```xml
    <properties>
        <jetty.version>11.0.15</jetty.version>
    </properties>
    ```

    3. **Key Jetty 11 changes:**
    - All `javax.servlet` â†’ `jakarta.servlet`
    - WebSocket API changes
    - Some deprecated APIs removed

    **Note:** Ensure all Jetty-related libraries are compatible with Jetty 11.
  links:
    - title: 'Spring Boot 3.0 Migration Guide - Jetty'
      url: https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#jetty
    - title: 'Jetty 11 Release Notes'
      url: https://github.com/eclipse/jetty.project/releases/tag/jetty-11.0.0

- ruleID: spring-boot-2.x-to-3.0-webapp-changes-00030
  category: potential
  effort: 2
  labels:
    - konveyor.io/source=spring-boot2
    - konveyor.io/target=spring-boot3+
  when:
    or:
    - builtin.filecontent:
        pattern: "spring.mvc.pathmatch.matching-strategy"
        filePattern: "application*.properties"
    - builtin.filecontent:
        pattern: "pathmatch"
        filePattern: "application*.yml"
  description: Path matching strategy defaults have changed
  message: |
    In Spring Boot 3.0, the default path matching strategy for Spring MVC has changed.

    **Key Changes:**
    - Default matching strategy is now `PathPatternParser` instead of `AntPathMatcher`
    - Trailing slash matching is disabled by default
    - Suffix pattern matching is disabled by default

    **If you need the old behavior:**
    ```properties
    # Use AntPathMatcher (legacy behavior)
    spring.mvc.pathmatch.matching-strategy=ant_path_matcher
    ```

    **Recommended approach:** Update your application to work with the new defaults,
    as `PathPatternParser` offers better performance.

    **Note:** If using Spring Security or Actuator, ensure consistent path matching
    configuration across all components.
  links:
    - title: 'Spring Boot 3.0 Migration Guide - Web Applications'
      url: https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#spring-mvc-and-webflux-url-matching-changes

- ruleID: spring-boot-2.x-to-3.0-webapp-changes-00040
  category: potential
  effort: 2
  labels:
    - konveyor.io/source=spring-boot2
    - konveyor.io/target=spring-boot3+
  when:
    java.referenced:
      pattern: org.springframework.boot.web.servlet.error.ErrorController
      location: IMPLEMENTS_TYPE
  description: ErrorController implementations may need updates
  message: |
    The `ErrorController` interface and error handling behavior has been refined in Spring Boot 3.0.

    **Key Changes:**
    - The `getErrorPath()` method has been removed from `ErrorController`
    - Error attribute handling has been updated
    - Custom error pages may need adjustment

    **Migration:**
    If your `ErrorController` implementation overrides `getErrorPath()`, remove that method
    and configure the error path via properties instead:

    ```properties
    server.error.path=/error
    ```

    Review your error handling logic to ensure compatibility with the updated error
    attribute structure.
  links:
    - title: 'Spring Boot 3.0 Migration Guide'
      url: https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide
