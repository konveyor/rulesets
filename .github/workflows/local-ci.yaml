name: Local CI

on: ["push", "pull_request"]
permissions:
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Java and Maven
        uses: s4u/setup-maven-action@v1.18.0
        with:
          java-version: 21
          java-distribution: temurin
          maven-version: 3.9.0

      - name: Run rule tests
        id: kantra-test
        env:
          JVM_MAX_MEM: "2560m" 
        run: |
          #### Block_Start ####
          # This block cleans up old java processes to avoid leaking memory, this will be removed when we fix the memory leak in the java provider.
          # Function to cleanup old processes matching a pattern, keeping only the newest
          # Uses pgrep -f for pattern matching (matches against full command line)
          # Example patterns: "java", "jdtls", "org.eclipse"
          cleanup_old_processes() {
            local pattern="$1"
            local interval="${2:-30}"
            
            while true; do
              # Get PIDs of processes matching the pattern (pgrep -f matches full command line)
              pids=$(pgrep -f "$pattern" 2>/dev/null | grep -v $$ || true)
              if [[ -n "$pids" ]]; then
                # Debug: show matching processes with details
                echo "[cleanup] Matching '$pattern' processes:"
                echo "$pids" | xargs -I{} ps -p {} -o pid,etimes,rss,comm --no-headers 2>/dev/null || true
                
                # Sort by elapsed time descending (oldest first has largest elapsed time)
                sorted_pids=$(echo "$pids" | xargs -I{} ps -p {} -o pid=,etimes= 2>/dev/null | sort -k2 -rn | awk '{print $1}')
                count=$(echo "$sorted_pids" | grep -c . 2>/dev/null || echo 0)
                
                if [[ $count -gt 1 ]]; then
                  # Kill all but the last one (newest has smallest elapsed time)
                  to_kill=$(echo "$sorted_pids" | head -n -1)
                  echo "[cleanup] Found $count processes matching '$pattern', killing $((count - 1)) oldest: $(echo $to_kill | tr '\n' ' ')"
                  echo "$to_kill" | xargs -r kill -9 2>/dev/null || true
                fi
              fi
              sleep "$interval"
            done
          }

          # Background system monitor to debug hangs
          monitor_system() {
            local interval="${1:-60}"
            local iteration=0
            
            while true; do
              iteration=$((iteration + 1))
              echo ""
              echo "========== [MONITOR #$iteration @ $(date)] =========="
              
              # Memory usage
              echo "--- MEMORY ---"
              free -h
              
              # Disk usage
              echo "--- DISK ---"
              df -h / /tmp 2>/dev/null || df -h
              
              # Top 10 memory-consuming processes
              echo "--- TOP 10 PROCESSES BY MEMORY ---"
              ps aux --sort=-%mem | head -11
              
              # Count of java/jdt processes
              echo "--- JAVA PROCESS COUNT ---"
              echo "Total java processes: $(pgrep -f java 2>/dev/null | wc -l)"
              echo "JDT-LS processes: $(pgrep -f 'org.eclipse.jdt.ls' 2>/dev/null | wc -l)"
              
              # Check for OOM killer activity
              echo "--- OOM KILLER CHECK ---"
              dmesg 2>/dev/null | grep -i "out of memory\|oom\|killed process" | tail -5 || echo "No OOM events (or no access to dmesg)"
              
              # Check if kantra is still running
              echo "--- KANTRA STATUS ---"
              if pgrep -f "kantra test" > /dev/null 2>&1; then
                echo "kantra test is running (PID: $(pgrep -f 'kantra test'))"
              else
                echo "kantra test is NOT running"
              fi
              
              echo "========== [END MONITOR #$iteration] =========="
              echo ""
              
              sleep "$interval"
            done
          }

          # Start background cleanup for JDT Language Server processes started by the Java provider
          cleanup_old_processes "org.eclipse.jdt.ls" 30 &
          CLEANUP_PID=$!
          
          # Start background system monitor (logs every 60 seconds)
          monitor_system 60 &
          MONITOR_PID=$!
          echo "Started background monitor (PID: $MONITOR_PID) and cleanup (PID: $CLEANUP_PID)"
          #### Block_End ####
          
          mkdir -p ~/.config/.kantra
          mv ./default/generated ~/.config/.kantra/rulesets
          cd ~/.config/.kantra
          ID=$(podman create --name kantra-download quay.io/konveyor/kantra:latest)
          podman cp ${ID}:/usr/local/bin/kantra .
          podman cp ${ID}:/usr/local/etc/maven.default.index .
          podman cp ${ID}:/usr/bin/fernflower.jar .
          podman cp ${ID}:/jdtls .
          mkdir static-report
          podman rm kantra-download
          JVM_MAX_MEM=2560m RUN_LOCAL=1 ./kantra test ./rulesets --log-level 50 | tee output.log || true
          tail -n5 output.log > message.md
          msg=$(grep -E '.*Rules Summary:' message.md -A1)
          tests_pass_rate=$(grep -E '.*Rules Summary:' message.md | sed -E 's| *Rules Summary: *(.*)|\1|' | sed -E 's|.*?:||')
          tcs_pass_rate=$(grep -E '.*Test Cases Summary:' message.md | sed -E 's| *Test Cases Summary: *(.*)|\1|' | sed -E 's|.*?:||')
          some_test_failed=$(echo ${tests_pass_rate} | awk -F' ' '{print$1}' | awk -F'/' '{print ($1 == $2) ? 0 : 1}')
          some_tcs_failed=$(echo ${tcs_pass_rate} | awk -F' ' '{print$1}' | awk -F'/' '{print ($1 == $2) ? 0 : 1}')
          
          echo 'msg<<EOF' >> $GITHUB_OUTPUT
          echo ${msg} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          echo 'tcs_pass_rate<<EOF' >> $GITHUB_OUTPUT
          echo ${tcs_pass_rate} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          echo 'tests_pass_rate<<EOF' >> $GITHUB_OUTPUT
          echo ${tests_pass_rate} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          if [[ ${some_test_failed} -eq 1 ]] || [[ ${some_tcs_failed} -eq 1 ]]; then
            exit 1
          else
            exit 0
          fi

      - name: Upload matching folders
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rules-test-folders
          path: /tmp/rules-test-*
          compression-level: 9
