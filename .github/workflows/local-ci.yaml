name: Local CI

on: ["push", "pull_request"]
permissions:
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper diff comparison

      - name: Install Java and Maven
        uses: s4u/setup-maven-action@v1.18.0
        with:
          java-version: 17
          java-distribution: temurin
          maven-version: 3.9.0

      - name: Determine rulesets to test
        id: get-rulesets
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Running in PR mode - detecting changed rulesets..."
            CHANGED_RULESETS=$(bash hack/get-changed-rulesets.sh origin/${{ github.base_ref }} | paste -sd ' ' -)

            if [ -z "$CHANGED_RULESETS" ]; then
              echo "No ruleset changes detected in this PR"
              echo "skip_tests=true" >> $GITHUB_OUTPUT
              echo "test_paths=" >> $GITHUB_OUTPUT
            else
              echo "Changed rulesets: $CHANGED_RULESETS"
              echo "skip_tests=false" >> $GITHUB_OUTPUT
              echo "test_paths=$CHANGED_RULESETS" >> $GITHUB_OUTPUT
            fi
          else
            echo "Running in push mode - testing all rulesets"
            echo "skip_tests=false" >> $GITHUB_OUTPUT
            echo "test_paths=./default/generated" >> $GITHUB_OUTPUT
          fi

      - name: Run rule tests
        id: kantra-test
        if: steps.get-rulesets.outputs.skip_tests != 'true'
        run: |
          ID=$(podman create --name kantra-download quay.io/konveyor/kantra:latest)
          podman cp ${ID}:/usr/local/bin/kantra .
          podman cp ${ID}:/usr/local/etc/maven.default.index .
          podman cp ${ID}:/usr/bin/fernflower.jar .
          podman cp ${ID}:/jdtls .
          mkdir rulesets static-report
          podman rm kantra-download

          # Run tests on the determined paths
          TEST_PATHS="${{ steps.get-rulesets.outputs.test_paths }}"
          echo "Testing rulesets: $TEST_PATHS"

          # Run kantra test for each ruleset path
          OVERALL_RESULT=0
          for TEST_PATH in $TEST_PATHS; do
            echo "Testing ruleset: $TEST_PATH"
            RUN_LOCAL=1 ./kantra test "$TEST_PATH" --log-level 50 | tee -a output.log || OVERALL_RESULT=$?
          done

          # Exit with failure if any test failed
          if [[ $OVERALL_RESULT -ne 0 ]]; then
            echo "Some tests failed"
            cat output.log
            exit 1
          fi
          tail -n5 output.log > message.md
          msg=$(grep -E '.*Rules Summary:' message.md -A1)
          tests_pass_rate=$(grep -E '.*Rules Summary:' message.md | sed -E 's| *Rules Summary: *(.*)|\1|' | sed -E 's|.*?:||')
          tcs_pass_rate=$(grep -E '.*Test Cases Summary:' message.md | sed -E 's| *Test Cases Summary: *(.*)|\1|' | sed -E 's|.*?:||')
          some_test_failed=$(echo ${tests_pass_rate} | awk -F' ' '{print$1}' | awk -F'/' '{print ($1 == $2) ? 0 : 1}')
          some_tcs_failed=$(echo ${tcs_pass_rate} | awk -F' ' '{print$1}' | awk -F'/' '{print ($1 == $2) ? 0 : 1}')
          
          echo 'msg<<EOF' >> $GITHUB_OUTPUT
          echo ${msg} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          echo 'tcs_pass_rate<<EOF' >> $GITHUB_OUTPUT
          echo ${tcs_pass_rate} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          echo 'tests_pass_rate<<EOF' >> $GITHUB_OUTPUT
          echo ${tests_pass_rate} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          if [[ ${some_test_failed} -eq 1 ]] || [[ ${some_tcs_failed} -eq 1 ]]; then
            exit 1
          else
            exit 0
          fi

      - name: Handle skipped tests
        id: skip-handler
        if: steps.get-rulesets.outputs.skip_tests == 'true'
        run: |
          echo "No ruleset changes detected in this PR - skipping tests"
          echo 'msg<<EOF' >> $GITHUB_OUTPUT
          echo "No ruleset changes detected - tests skipped" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
          echo 'tests_pass_rate<<EOF' >> $GITHUB_OUTPUT
          echo "N/A" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
          echo 'tcs_pass_rate<<EOF' >> $GITHUB_OUTPUT
          echo "N/A" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

#      - name: Comment on the PR
#        if: ${{ github.event_name == 'pull_request' }}
#        uses: actions/github-script@v6
#        with:
#          script: |
#            const issue_number = context.payload.pull_request.number;
#            const owner = context.repo.owner;
#            const repo = context.repo.repo;
#            const body = `${{ steps.kantra-test.outputs.msg }}`;
#
#            const comments = await github.rest.issues.listComments({
#              owner,
#              repo,
#              issue_number
#            });
#
#            const botComment = comments.data.find(comment =>
#              comment.user.login === 'github-actions[bot]');
#
#            if (botComment) {
#              await github.rest.issues.updateComment({
#                owner,
#                repo,
#                comment_id: botComment.id,
#                body
#              });
#            } else {
#              await github.rest.issues.createComment({
#                owner,
#                repo,
#                issue_number,
#                body
#              });
#            }
#          github-token: ${{ secrets.GITHUB_TOKEN }}
#          debug: true

      - name: Upload matching folders
        if: steps.get-rulesets.outputs.skip_tests != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: rules-test-folders
          path: /tmp/rules-test-*
          compression-level: 9

      - name: Update tests badge
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: konveyor-rulesets-tests-rate
          LABEL: Test Status
          STATUS: ${{ steps.kantra-test.outputs.tests_pass_rate }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update test case badge
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: konveyor-rulesets-tcs-rate
          LABEL: Test Case Status
          STATUS: ${{ steps.kantra-test.outputs.tcs_pass_rate }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            
        
