name: Local CI

on: ["push", "pull_request"]
permissions:
  pull-requests: write

jobs:
  test-jandepora:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v3

      - name: Run kantra test
        id: kantra-test
        continue-on-error: true
        run: |
          set -x
        # install kantra, copying from the latest image
          ID=$(podman create --name kantra-download quay.io/konveyor/kantra:latest)
          podman cp $(ID):/usr/local/bin/kantra .
          podman cp $(ID):/usr/local/etc/maven.default.index .
          podman cp $(ID):/usr/bin/fernflower.jar .
          podman cp $(ID):/jdtls .
          podman rm kantra-download
          RUN_LOCAL=1 ./kantra test ./default/generated --log-level 50 | tee output.log || true
          tail -n5 output.log > message.md
          msg=$(grep -E '.*Rules Summary:' message.md -A1)
          tests_pass_rate=$(grep -E '.*Rules Summary:' message.md | sed -E 's| *Rules Summary: *(.*)|\1|' | sed -E 's|.*?:||')
          tcs_pass_rate=$(grep -E '.*Test Cases Summary:' message.md | sed -E 's| *Test Cases Summary: *(.*)|\1|' | sed -E 's|.*?:||')
          some_test_failed=$(echo ${tests_pass_rate} | awk -F' ' '{print$1}' | awk -F'/' '{print ($1 == $2) ? 0 : 1}')
          some_tcs_failed=$(echo ${tcs_pass_rate} | awk -F' ' '{print$1}' | awk -F'/' '{print ($1 == $2) ? 0 : 1}')
          
          echo 'msg<<EOF' >> $GITHUB_OUTPUT
          echo ${msg} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          echo 'tcs_pass_rate<<EOF' >> $GITHUB_OUTPUT
          echo ${tcs_pass_rate} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          echo 'tests_pass_rate<<EOF' >> $GITHUB_OUTPUT
          echo ${tests_pass_rate} >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          if [[ ${some_test_failed} -eq 1 ]] || [[ ${some_tcs_failed} -eq 1 ]]; then
            exit 1
          else
            exit 0
          fi

#      - name: Comment on the PR
#        if: ${{ github.event_name == 'pull_request' }}
#        uses: actions/github-script@v6
#        with:
#          script: |
#            const issue_number = context.payload.pull_request.number;
#            const owner = context.repo.owner;
#            const repo = context.repo.repo;
#            const body = `${{ steps.kantra-test.outputs.msg }}`;
#
#            const comments = await github.rest.issues.listComments({
#              owner,
#              repo,
#              issue_number
#            });
#
#            const botComment = comments.data.find(comment =>
#              comment.user.login === 'github-actions[bot]');
#
#            if (botComment) {
#              await github.rest.issues.updateComment({
#                owner,
#                repo,
#                comment_id: botComment.id,
#                body
#              });
#            } else {
#              await github.rest.issues.createComment({
#                owner,
#                repo,
#                issue_number,
#                body
#              });
#            }
#          github-token: ${{ secrets.GITHUB_TOKEN }}
#          debug: true

      - name: Update tests badge
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: konveyor-rulesets-tests-rate
          LABEL: Test Status
          STATUS: ${{ steps.kantra-test.outputs.tests_pass_rate }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update test case badge
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: konveyor-rulesets-tcs-rate
          LABEL: Test Case Status
          STATUS: ${{ steps.kantra-test.outputs.tcs_pass_rate }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            
        
